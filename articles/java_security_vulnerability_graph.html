<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>JEXP | Finding Security Vulnerabilities with Cypher and Neo4j</title>
    <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href='/css/jexp.css' type='text/css' />
  <link rel="openid.server" href="http://jexp.de/id" />
<!--HeaderText--><style type='text/css'><!--
  div.wikibody { line-height: 1.6em; font-size:1.4em; }
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .vspace { margin-top:1.33em; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
   
  table.tabtable { border-collapse: collapse; }
  table.tabtable td { border:1px solid #cccccc; }

div.sourceblock {
	padding: 0.5em;
	border: 1px solid #808080;
	background-color: #F1F0ED; }
div.sourceblock div {
	font-family: monospace;
	font-size: small;
	line-height: 1; }
div.sourceblock div.head, div.sourceblock div.foot {
	font: italic medium serif;
	padding: 0.5em;
}
div.codeblock {
	padding: 0.5em;
	border: 1px solid #808080;
	background-color: #F1F0ED; }
div.codeblock pre {
	font-family: monospace;
	font-size: small;
	line-height: 1; }.editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
   
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style>
    <meta name='robots' content='index,follow' />


</head>
<body>
<!--PageHeaderFmt-->
  <div id='wikihead'><a href='/'><img src='/img/jexp.gif'
    alt='JEXP' border='0' align="center" /></a>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    JEXP</div>
<!--/PageHeaderFmt-->

<div id="wikileft">
   <ul>
	<li><a class='urllink' href='http://www.jexp.de/blog'>BLOG</a></li>
	<li><a class='urllink' href='http://github.com/jexp'>GitHub</a></li>
	<li><a class='urllink' href='/conferences.html'>Conferences</a></li>
	<li><a class='urllink' href='/articles.html'>Articles</a></li>
	<li><a class='urllink' href='/books.html'>Books</a></li>
	<li><a class='urllink' href='/projects.html'>Projects</a></li>
	<li><a class='urllink' href='/bio.html'>Bio</a></li>
<!--
<li><a class='wikilink' href='/Main.Projects'>Projects</a>
<p class='vspace'></p></li><li><a class='wikilink' href='/Info.Biografie'>Bio</a>
<p class='vspace'></p></li><li><a class='wikilink' href='/Business.Referenzen'>References</a>
<p class='vspace'></p></li><li><a class='wikilink' href='/Info.Links'>Links</a>
</li><li><a class='urllink' href='http://www.librarything.com/catalog/mesirii' rel='nofollow'>Books</a>
<p class='vspace'></p></li><li><a class='wikilink' href='/Info.BetterDevelopment'>BetterDevelopment</a>
</li><li><a class='wikilink' href='/Info.Konferenzen'>Conferences</a>
</li><li><a class='wikilink' href='/Info.Demotivators'>Demotivators</a>
</li><li><a class='wikilink' href='/Info.Quotes'>Quotes</a>
</li><li><a class='wikilink' href='/Main.Reviews'>Reviews</a>
<ul><li><a class='wikilink' href='/DslBook.DslBook'>DslBook</a>
</li></ul></li><li><a class='wikilink' href='/Main.Java'>Java</a>
<ul><li><a class='urllink' href='http://jequel.de' rel='nofollow'>Jequel</a>
</li><li><a class='wikilink' href='/BricksAndMortar.BricksAndMortar'>BricksAndMortar</a>
</li><li><a class='wikilink' href='/Java.Projects'>Look@Projects</a>
</li><li><a class='wikilink' href='/Java.Spring'>Spring</a>
</li><li><a class='wikilink' href='/Java.Code'>Code</a>
</li></ul><p class='vspace'></p></li><li><a class='wikilink' href='/Site.Impressum'>Impressum</a>
<p class='vspace'></p></li><li><a class='wikilink' href='/Site.Internal'>Internal</a>
</li>
-->

</ul>

</div>

<div id="wikibody">

<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post I want to demonstrate how Neo4j and open source tools like <a href="http://jqassistant.org/get-started">jQAssistant</a> can be used to detect vulnerabilities in software systems.
Such issuses are usually based on certain execution patterns of code, which individually are harmless, but become critical when combined.</p>
</div>
<div class="paragraph">
<p>As an example I want to use the Deserialization Vulnerability that was hot news in November 2015.
I&#8217;d like to show you how you can test yourself for any combination of libraries, if similar issues can be triggered.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_java_deserialization_rce_vulnerability">The Java Deserialization RCE Vulnerability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the beginning of November a wave of security alerts were raised in the Java ecosystem.
A large number of application servers, CI setups and other systems were reported to exhibit a remote code execution issue.</p>
</div>
<div class="paragraph">
<p>This issue is based upon the unchecked deserialization of untrustworthy user supplied data into Java objects.
During/after the deserialization process, methods were executed on objects resulting from that data which would eventually lead to arbitrary code execution on the JVM
and even on the host system (via <code>Runtime.exec</code>).</p>
</div>
<div class="paragraph">
<p>The issue was first presented by Chris Frohoff and Gabriel Lawrence already in January 2015 at AppSecCali2015.</p>
</div>
<div class="paragraph">
<p>It is built upon serializing an instance of a JDK-class (<code>AnnotationInvocationHandler</code>) which happens to call methods on the deserialized data in its <code>readObject</code> method.
This fact was combined with the ability of the <em>Apache Commons Collections</em> project&#8217;s ability to wrap collection classes in transformer facilities.
One of which (<code>InvokerTransformer</code>) can be configured to dynamically use methods for the value transformations using reflection on the JVM.
Combined with Java&#8217;s ability to run operating system or other commands on the host machine via <code>Runtime.exec</code> it opens the door to arbitrary code execution.</p>
</div>
<div class="paragraph">
<p>Many Java servers accept serialized Java objects over the wire and deserialize that data within their process.
This happens for protocols like RMI, JMS and JMX but also often for custom RPC and other protocols.</p>
</div>
<div class="paragraph">
<p>Java code running on a server is not subject to the JVM security manager sandbox by default.
That&#8217;s why this code execution is not protected against automatically.</p>
</div>
<div class="paragraph">
<p>But due to the complexity of the setup and the less pronounced presentation of the issue, it was mostly ignored by other researchers and the public.</p>
</div>
<div class="paragraph">
<p>Only in late October Code White researcher Matthias Kaiser, demonstrated in detail how to remoteley execute code on an Atlassian Bamboo installation.
This was picked up by Steve Breen who demonstrated similar vulnerabilities with other popular application servers (e.g. WebLogic, IBM WebSphere, JBoss, Jenkins, OpenNMS).
Without notifying the vendors of these products, he wrote a quite polemic blog post on the subject, which was quickly picked up by news outlets.</p>
</div>
<div class="paragraph">
<p>Most of the mentioned products and projects have released fixed versions of their software but there are certainly still a lot of vulnerable installations running.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_vulnerability_pattern">The Vulnerability Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The basic pattern of this vulnerability is pretty straightforward.
It is more or less a long execution chain, which starts with an class that is serializable (i.e. transitively implements <code>java.io.Serializable</code>) and also contains a <code>readObject</code> method.
The chain ends with a call to <code>java.lang.reflect.Method.invoke()</code>.</p>
</div>
<div class="paragraph">
<p>Within that chain you have invocations either directly on target methods or on methods on interfaces / base-classes that are then implemented by methods transitively leading to the expected chain end.</p>
</div>
<div class="paragraph">
<p>This is a visual representation:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/model_arrows.jpg" alt="model arrows">
</div>
</div>
<div class="paragraph">
<p>In a graph model you can represent code as a graph with Nodes for <em>packages, classes, interfaces, methods, fields, parameters</em> and Relationships for <em>inheritance, delegation, invocation, read- and write operations</em>.</p>
</div>
<div class="paragraph">
<p>In such a model then declaring the start- and end-method becomes straightforward and the arbitrary long execution-chain turns into a shortest-path operation.</p>
</div>
<div class="paragraph">
<p>Fortunately there are tools that provide this out of the box. Meet jQAssistant.</p>
</div>
<div class="paragraph">
<p>In my first encounter with Neo4j in 2008 I experimented with loading the JDK class library into Neo4j using the aforementioned model, even without Cypher this was really fast and fun to play with.
Years later I had a long conversation with my friend Dirk Mahler about software analytics with graphs, around code-quality, software-erosion, architectural rules and the lack of flexibility in commercial tools.</p>
</div>
<div class="paragraph">
<p>Our discussions eventually led to the creation to the open-source project jQAssistant, which is a software analytics toolkit built upon Neo4j, Cypher and an extensible plugin system.
Basically it uses plugins to parse information not only from source code but also many other sources (build-files, database-metadata, descriptors, config-servers and many more).
The initial graph model from that raw data is then enriched using provided concepts and custom techncial (e.g. Service,Test,UI-Component) and business (e.g. Order-Management, Recommendation-Engine, User-Profile) concepts.
In most cases these are applied as node-labels representing higher level concepts but can also be more complex graph structures.</p>
</div>
<div class="paragraph">
<p>Based on the enriched raw graph data, you can compute metrics and output reports for your software project.
But most interestingly you can create your own architectural constraints or other rules that the entirety of your project should adhere to.
If the constraints return offending violations, then those are reported and your project build can be made to fail.</p>
</div>
<div class="paragraph">
<p>All concepts, constraints, metrics and reports are declared as Cypher statements, either in self-documenting text documents or XML descriptors.
Each of them can depend on others, so during their application requirements are automatically resolved and you only run the minimal set of Cypher statements necessary.</p>
</div>
<div class="paragraph">
<p>You can use the full richness of Cypher to match patterns, compute cardinalities or compare collections of elements.</p>
</div>
<div class="paragraph">
<p>More details about jQAssitant can be found on the <a href="http://jqassistant.org">project site</a>, in <a href="http://jqassistant.org/blog">dedicated blog posts</a> and <a href="http://jqassistant.org/dcos">the extensive documentation</a>.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s see how we can use this toolset to find security vulnerabilities in our code.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/jqa_model" alt="jqa model">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_locate_the_pattern_using_jqassistant_and_cypher">Locate the Pattern using jQAssistant and Cypher</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After <a href="http://jqassistant.org/download">downloading jQAssistant</a>, you can simply scan a folder containing the relevant JAR-files.
In our case the <code>rt.jar</code> from the JDK and the <code>commons-collections.jar</code> from Apache Commons Collections.
For your own use-case it makes sense to scan the combination of jars you use in your application-server and/or project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/jqassistant.sh scan -f lib/*.jar</pre>
</div>
</div>
<div class="paragraph">
<p>If you just want to explore the scanned data, you run the Neo4j server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/jqassistant.sh server</pre>
</div>
</div>
<div class="paragraph">
<p>First, let&#8217;s think about what we&#8217;re looking for.
We discussed it above in prose.
What would it look like as Cypher statements using the jQAssistant Java-plugin graph-model.</p>
</div>
<div class="paragraph">
<p>If we start with the endpoints of our vulnerability execution chain:</p>
</div>
<div class="listingblock">
<div class="title">Serializable classes that implement <code>readObject</code> (393 classes)</div>
<div class="content">
<pre class="highlight"><code class="cypher language-cypher">MATCH (:Interface {fqn:"java.io.Serializable"})&lt;-[:EXTENDS*]-(class),
      (class)-[:DECLARES]-&gt;(m:Method {name:"readObject"})
RETURN count(*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calls of the method <code>java.lang.reflect.Method.invoke()</code>: (258 calls)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="cypher language-cypher">MATCH (:Class {fqn:"java.lang.reflect.Method"})-[:DECLARES]-&gt;(m:Method {name:"invoke"})
RETURN size(()-[:INVOKES]-&gt;(m)) as invocations;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enrich our existing model, so that is more suitable for scanning across jars and along method overrides we need to run two additional concepts.
Both of which are provided by the Java-Plugin but not applied by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/jqassistant.sh analyze -concepts classpath:Resolve,java:MethodOverrides</pre>
</div>
</div>
<div class="paragraph">
<p>Now we have everything in place to determine the transitive connection between deserializing objects which from within <code>readObject</code> call <code>Method.invoke()</code> over several intermediate steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="cypher language-cypher">MATCH (:Interface {fqn:"java.io.Serializable"})&lt;-[:EXTENDS*]-&gt;(serialized:Class)-[:DECLARES]-&gt;(readObject:Method {name:"readObject"})
MATCH (:Class {fqn:"java.lang.reflect.Method"})-[:DECLARES]-&gt;(invoke:Method {name:"invoke"})

MATCH path = shortestPath((readObject)-[:INVOKES|:OVERRIDDEN_BY*]-&gt;(invoke))

RETURN serialized,path
ORDER BY length(path) ASC LIMIT 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see one of the many paths that represent a potential vulnerability and could / should be examined more closely.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/jqassistant_deserialize_vulnerability_example1.jpg" alt="jqassistant deserialize vulnerability example1">
</div>
</div>
<div class="paragraph">
<p>This was just one example how software analytics with Neo4j can be used to immediately acquire highly valuable information about your software projects.</p>
</div>
<div class="paragraph">
<p>There are many more applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>manage consistency of transitive library dependencies of a multitude of projects</p>
</li>
<li>
<p>infer software modules from an unstructured codebase</p>
</li>
<li>
<p>incrementally improve software quality by using team-provided language or architectural rules</p>
</li>
<li>
<p>assert synchronization between database (or other) metadata and related code</p>
</li>
<li>
<p>structural search of "interesting" code structures</p>
</li>
<li>
<p>generate graph visualizations with virtual nodes and relationships that aggregate lower level metrics and dependencies</p>
</li>
<li>
<p>manage service or component visibility and discoverability even in absence of a module system</p>
</li>
<li>
<p>enrich static structural information with runtime trace information, heap structures, test execution results, build information, component interactions to discover new insights or support decisions for your team or yourself</p>
</li>
<li>
<p>render information derived from the graph as interactive graphs, charts, diagrams, city-maps with drill-down and comparison abilities</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have other cool ideas of what you could achieve by treating information around software projects as a graph, <a href="mailto:michael@neo4j.com">please let me know</a>.
You can also join our <a href="http://groups.google.com/group/graph-software-analytics">graph-software-analytics google group</a> and share your ideas or related projects there.</p>
</div>
</div>
</div>

</div>


  <div id='wikifoot' class="footnav">
    <div style="text-align:right; float:right" class='lastmod'>Last updated 2015-12-16 21:50:56 CET</div>
	
      <div style="text-align:center;">
      <a href='http://jexp.de/impressum'>Impressum</a>
    - <a class='urllink' href='http://twitter.com/mesirii'>Twitter</a>
	- <a class='urllink' href='http://github.com/jexp'>GitHub</a>
	- <a class='urllink' href='http://stackoverflow.com/users/story/728812'>StackOverflow</a>
	- <a class='urllink' href='http://linkedin.com/jexpde'>LinkedIn</a>
	
   </div>

</body>
</html>